<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/607017 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="686"/>
<h1>docker容器技术与应用  第5周  笔记</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2023/3/13 10:57</i></td></tr>
<tr><td><b>更新时间：</b></td><td><i>2023/3/20 10:25</i></td></tr>
<tr><td><b>作者：</b></td><td><i>程露</i></td></tr>
</table>
</div>
<br/>

<div>
<span><div><div><span style="font-size: 18pt; color: rgb(30, 204, 255); font-weight: bold;">接上一周笔记：</span></div><div><br/></div><div><span style="font-size: 16pt; color: rgb(166, 0, 196);">7）docker  run   运行容器:</span></div><div><span style="font-size: 14pt;background-color: rgb(255, 250, 165);-evernote-highlight:true;">7.7：</span></div><div><span style="font-size: 14pt;">[root@docker1 /]#</span><span style="font-size: 14pt;">docker run -d</span> <span style="font-size: 14pt; font-weight: bold;">-e mysqlID=192.168.0.1</span><span style="font-size: 14pt;">  httpd  </span><span style="font-size: 14pt; color: rgb(77, 206, 29);">//运行一个httpd，后台运行，传递一个环境变量</span><span style="font-size: 14pt; color: rgb(77, 206, 29);">mysqlID，值为</span><span style="font-size: 14pt; color: rgb(77, 206, 29);">192.168.0.1</span></div><div><span style="font-size: 14pt;background-color: rgb(255, 250, 165);-evernote-highlight:true;">7.8：</span></div><div><span style="font-size: 14pt;">[root@docker1 /]#</span><span style="font-size: 14pt;">docker run -d</span> <span style="font-size: 14pt;"> </span><span style="font-size: 14pt; font-weight: bold;">--dns  119.29.29.29</span><span style="font-size: 14pt;">  httpd  </span><span style="font-size: 14pt; color: rgb(77, 206, 29);">//运行一个httpd，后台运行，为容器指定一个dns服务器</span></div><div><span style="font-size: 14pt;background-color: rgb(255, 250, 165);-evernote-highlight:true;">7.9：</span></div><div><span style="font-size: 14pt;">[root@docker1 /]#</span><span style="font-size: 14pt;">docker run -d</span> <span style="font-size: 14pt;"> </span><span style="font-size: 14pt; font-weight: bold;">--rm</span><span style="font-size: 14pt;">  httpd  </span><span style="font-size: 14pt; color: rgb(77, 206, 29);">//运行一个httpd，后台运行，容器退出时自动删除</span></div><div><br/></div><div><span style="font-size: 16pt; color: rgb(166, 0, 196);">8）docker  exec  进入容器，退出时不结束容器进程</span></div><div><span style="font-size: 14pt;">[root@docker1 /]# docker exec -it 29 /bin/bash  </span><span style="font-size: 14pt; color: rgb(77, 206, 29);">//进入容器29</span></div><div><span style="font-size: 14pt;">root@29dc8aa9738d:/usr/local/apache2# </span></div><div><br/></div><div><span style="font-size: 16pt; color: rgb(166, 0, 196);">9</span><span style="font-size: 16pt; color: rgb(166, 0, 196);">）docker  attach  连接容器，退出时即刻结束容器进程</span></div><div><span style="font-size: 14pt;">[root@docker1 /]# docker attach d4  </span></div><div><span style="font-size: 14pt;">[Mon Apr 04 16:33:53.165191 2022] [mpm_event:notice] [pid 1:tid 140488014441792] AH00492: caught SIGWINCH, shutting down gracefully</span></div><div><span style="font-size: 14pt; color: rgb(227, 0, 0);">*docker exec 不会影响容器运行的状态，而docker attach 会影响容器运行的状态，即退出容器，容器会被终止运行</span></div><div><br/></div><div><span style="font-size: 16pt; color: rgb(166, 0, 196); font-family: unset;">10</span><span style="font-size: 16pt; color: rgb(166, 0, 196);">）</span><span style="font-size: 16pt; color: rgb(166, 0, 196); font-family: unset;">docker  stop  停止容器</span></div><div><span style="font-size: 14pt;">[root@docker1 /]# docker stop d40e5a282f8a</span></div><div><span style="font-size: 14pt;">d40e5a282f8a</span></div><div><span style="font-size: 14pt; color: rgb(227, 0, 0);">*使用stop停止容器，容器属于正常退出状态</span></div><div><br/></div><div><span style="font-size: 16pt; color: rgb(166, 0, 196); font-family: unset;">11）</span><span style="font-size: 16pt; color: rgb(166, 0, 196);">docker  kill  强制停止容器</span></div><div><span style="font-size: 14pt;">[root@docker-ce nginx]# docker kill http-5</span></div><div><span style="font-size: 14pt;">http-5</span></div><div><br/></div><div><span style="font-size: 16pt; color: rgb(166, 0, 196);">12）</span><span style="font-size: 16pt; color: rgb(166, 0, 196);">docker  rm   删除容器</span></div><div><span style="font-size: 14pt;"> [root@docker1 /]# docker  rm </span> <span style="font-size: 14pt; font-weight: bold;">$(docker ps -qa) </span> <span style="font-size: 14pt; color: rgb(77, 206, 29);">//批量删除所有容器</span></div><div><span style="font-size: 14pt;">b6bd7a3e1099</span></div><div><span style="font-size: 14pt;">d40e5a282f8a</span></div><div><span style="font-size: 14pt;">29dc8aa9738d</span></div><div><br/></div><div><img src="docker容器技术与应用  第5周  笔记_files\en_todo.png"/><span style="font-size: 16pt; color: rgb(166, 0, 196);">13）</span><span style="font-size: 16pt; color: rgb(166, 0, 196);">docker  restart  重启容器</span></div><div><span style="font-size: 14pt;">[root@docker-ce docker]# docker restart http-1</span></div><div><span style="font-size: 14pt;">http-1</span></div><div><span style="font-size: 14pt;">[root@docker-ce docker]# docker ps -l</span></div><div><span style="font-size: 14pt;">CONTAINER ID   IMAGE     COMMAND              CREATED          STATUS         PORTS     NAMES</span></div><div><span style="font-size: 14pt;">c97c6a20e6bf   httpd     &quot;httpd-foreground&quot;   33 seconds ago   Up 3 seconds   80/tcp    http-1</span></div><div><br/></div><div><img src="docker容器技术与应用  第5周  笔记_files\en_todo [1].png"/><span style="font-size: 21.3333px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(166, 0, 196); font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal;">14）</span><span style="font-size: 16pt; color: rgb(166, 0, 196);">docker  port  -&gt;  查看容器端口映射</span></div><div><span style="font-size: 14pt;">[root@docker-ce docker]# docker port nginx-1</span></div><div><span style="font-size: 14pt;">80/tcp -&gt; 0.0.0.0:49153</span></div><div><span style="font-size: 14pt;">80/tcp -&gt; :::49153</span></div><div><br/></div><div><img src="docker容器技术与应用  第5周  笔记_files\en_todo [2].png"/><span style="font-size: 21.3333px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(166, 0, 196); font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal;">15）</span><span style="font-size: 16pt; color: rgb(166, 0, 196);">docker  cp  </span><span style="font-size: 16pt; color: rgb(166, 0, 196); font-family: unset;">  -&gt;  复制本地文件到容器的文件系统中</span></div><div><span style="font-size: 14pt;">[root@docker-ce ~]# echo &quot;hello nginx&quot;&gt;&gt;index.html</span></div><div><span style="font-size: 14pt;">[root@docker-ce ~]# docker cp index.html nginx-1:/usr/share/nginx/html</span></div><div><span style="font-size: 14pt;">[root@docker-ce ~]# docker exec -it nginx-1 /bin/bash</span></div><div><span style="font-size: 14pt;">root@5644bac35411:/# cd /usr/share/nginx/html/</span></div><div><span style="font-size: 14pt;">root@5644bac35411:/usr/share/nginx/html# ls</span></div><div><span style="font-size: 14pt;">index.html</span></div><div><span style="font-size: 14pt;">root@5644bac35411:/usr/share/nginx/html# cat index.html</span></div><div><span style="font-size: 14pt;">hello nginx</span></div><div><span style="font-size: 14pt; color: rgb(255, 70, 53);">注意：当容器已经运行起来了，这时，需要传递文件给容器内部使用，就建议使用docker  cp。</span></div><div><span style="font-size: 14pt;"><br/></span></div><div><span style="font-size: 16pt; color: rgb(255, 0, 0); font-weight: bold;">八、docker镜像的构建</span></div><div><span style="font-size: 18.6667px; color: rgb(166, 0, 196); font-weight: bold;">docker镜像的构建有以下两种方式：</span></div><div><span style="font-size: 14pt; color: rgb(166, 0, 196); font-weight: bold;">1）docker commit  :  基于容器做变更，再将容器打包成新的镜像；</span></div><div><span style="font-size: 14pt; color: rgb(166, 0, 196); font-weight: bold;">2）Dockerfile  : 基于基础镜像做变更，再使用docker  build命令生成新的镜像。</span><span style="font-size: 14pt;">docker  build   -t   $image_name  . </span></div><div><span style="font-size: 14pt; font-weight: bold;">1、docker  commit手动构建镜像</span></div><ul><li><div><span style="font-size: 14pt; font-weight: bold;">案例：某容器云厂商的centos镜像闭环管理项目</span></div></li></ul><div><br/></div><div><span style="font-size: 14pt;">1）将tar包加载为镜像：docker  load -i  centos_latest.tar.gz</span></div><div><span style="font-size: 14pt;">2）创建私有仓库：</span></div><div><span style="font-size: 14pt;">     docker  run  -d -p 5000:5000 --name registry --restart=always  registry</span></div><div><span style="font-size: 14pt;">     vim   /etc/docker/daemon.json   -&gt; </span></div><div><span style="font-size: 14pt;">     {</span></div><div><span style="font-size: 14pt;">            &quot;insecure-registries&quot;:[&quot;$docker_IP:5000&quot;],</span></div><div><span style="font-size: 14pt;">            &quot;registry-mirrors&quot;:[&quot;</span><a href="https://8djob8sk.mirror.aliyuncs.com/" style="font-size: 14pt;">https://8djob8sk.mirror.aliyuncs.com</a><span style="font-size: 14pt;">&quot;]</span></div><div><span style="font-size: 14pt;">     }</span></div><div><span style="font-size: 14pt;">     systemctl  daemon-reload</span></div><div><span style="font-size: 14pt;">     systemctl  restart  docker</span></div><div><span style="font-size: 14pt;">3）</span><span style="font-size: 14pt;">将镜像</span><span style="font-size: 14pt;">打上仓库标签：docker  tag $image_ID docker:5000/centos:latest</span></div><div><span style="font-size: 14pt;">4）将镜像推送到私有仓库：docker push </span> <span style="font-size: 14pt;">$docker_IP:</span><span style="font-size: 14pt;">5000/centos:latest</span></div><div><span style="font-size: 14pt;">      registry容器内部存放镜像的路径：</span></div><div><span style="font-size: 14pt;">    docker exec  -it  registry /bin/sh  -&gt;</span></div><div><span style="font-size: 14pt;">    /var/lib/registry/docker/registry/v2/repositories</span></div><div><span style="font-size: 14pt;">   </span> <span style="font-size: 14pt;background-color: rgb(255, 250, 165);-evernote-highlight:true;">curl  <a href="http://docker:5000/v2/_catalog" style="background-color: rgb(255, 250, 165);font-size: 14pt;-evernote-highlight:true;">http://docker:5000/v2/_catalog</a></span></div><div><span style="font-size: 14pt;">   </span> <span style="font-size: 14pt;background-color: rgb(255, 250, 165);-evernote-highlight:true;">浏览器访问地址：<a href="http://192.168.100.10:5000/v2/_catalog" style="background-color: rgb(255, 250, 165);font-size: 14pt;-evernote-highlight:true;">http://192.168.100.10:5000/v2/_catalog</a></span></div><div><span style="font-size: 14pt;">5）将镜像下载至本地：docker pull</span> <span style="font-size: 14pt;">$docker_IP:</span><span style="font-size: 14pt;">5000/centos:latest</span></div><div><span style="font-size: 14pt;">6）将镜像跑成容器：docker run -itd </span> <span style="font-size: 14pt;">$docker_IP:</span><span style="font-size: 14pt;">5000/centos:latest  /bin/bash</span></div><div><span style="font-size: 14pt;">7）进入容器对其做变更：docker  exec  -it  $container_ID  /bin/bash  </span></div><div><span style="font-size: 14pt;">             -&gt;  安装一个vim工具</span></div><div><span style="font-size: 14pt;">8）将容器制作成镜像：docker  commit  -a &quot;chenglu&quot; -m &quot;centos+vim&quot;  $container_ID  centos:vim  -&gt;  实质是给容器当前状态打一个快照，保存到docker里面。</span></div><div><span style="font-size: 14pt;">9）将新的镜像打上仓库标签：docker  tag  $image_ID</span> <span style="font-size: 14pt;">$docker_IP:</span><span style="font-size: 14pt;">5000/centos:vim</span></div><div><span style="font-size: 14pt;">10）将新的镜像推送到仓库：docker  push </span> <span style="font-size: 14pt;">$docker_IP:</span><span style="font-size: 14pt;">5000/centos:vim</span></div><div><span style="font-size: 14pt;">11）将镜像下载到docker远程主机：docker  pull  docker:5000/centos:vim</span></div><div><span style="font-size: 14pt;">12）在远程主机上将新的镜像跑成容器：docker  run  -itd </span> <span style="font-size: 14pt;">$docker_IP:</span><span style="font-size: 14pt;">5000/centos:vim /bin/bash</span></div><div><span style="font-size: 14pt;">13）到容器里面验证vim是否已安装可用</span></div><div><span style="font-size: 14pt;">14）将容器导出为tar包：docker  export  -o  </span><span style="font-size: 14pt;">centos_vim.tar  $container_ID</span><span style="font-size: 14pt;">  等于 docker  export  $container_ID &gt; </span><span style="font-size: 14pt;">centos_vim.tar</span></div><div><span style="font-size: 14pt;">15）将镜像导出为tar包：docker save -o centos_vim.tar  $image_ID  </span> <span style="font-size: 14pt;">等于  docker  save  $image_ID  &gt;  </span><span style="font-size: 14pt;">centos_vim.tar</span></div><div><span style="font-size: 14pt;">16）查看远程主机的tar包是否生成: ls  ./</span></div></div><div><br/></div></span>
</div></body></html> 